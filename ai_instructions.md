# Инструкция для ИИ-ассистента по проекту Tutor

## 1. Общее описание

**Цель проекта:** Создать интерактивное обучающее приложение на Python (PyQt5), которое помогает пользователю изучать текстовые материалы (книги .txt, .docx). Приложение использует локально запущенную LLM (например, через LM Studio API) для генерации объяснений текста и создания упражнений для проверки понимания.

**Ключевые возможности:**
*   Загрузка книг и создание "курсов" на их основе.
*   Разделение книги на секции по маркеру `-=раздел=-`.
*   Отображение текста выбранной секции.
*   Генерация объяснений для текста секции с помощью LLM (с настройкой детализации и возможностью уточнения через фидбэк).
*   Генерация упражнений (тесты, открытые вопросы и т.д.) по тексту секции с помощью LLM (с настройкой сложности).
*   Проверка ответов пользователя на упражнения с помощью LLM, предоставление обратной связи.
*   Сохранение и загрузка прогресса пользователя по курсу.
*   Настройка параметров LLM (API endpoint, модель, токены, температура) и параметров генерации (детализация, сложность).

**Технологический стек:**
*   Python 3.10+
*   PyQt5 (GUI)
*   python-docx (чтение .docx)
*   requests (взаимодействие с LLM API)
*   JSON (хранение настроек, структуры курса, прогресса)

## 2. Структура проекта

Проект состоит из главного GUI-приложения (`main.py`) и набора модульных скриптов (`_XX_module_name.py`), каждый из которых реализует одну специфическую функцию.

**Основные компоненты:**
*   **`main.py`**: Главный файл приложения, реализующий интерфейс PyQt5. Содержит класс `MainWindow` с трехпанельным интерфейсом (Исходный текст, Объяснение, Упражнение) и класс `SettingsDialog` для настроек. Оркестрирует взаимодействие пользователя с интерфейсом и вызывает функции из других модулей.
*   **Модули `_X_*.py`**: Реализуют бэкенд-логику:
    *   **Работа с файлами и курсами:**
        *   `_1_load_book.py`: Загрузка текста из `.txt` или `.docx`.
        *   `_2_parse_structure.py`: Разбор текста на секции по маркеру `-=раздел=-`. Возвращает список словарей секций (`id`, `title`, `content`).
        *   `_3_initialize_course.py`: Создание директории курса, `structure.json` (из `_2_parse_structure`) и `progress.json` (пустой) на основе файла книги.
        *   `_6_load_course_structure.py`: Загрузка `structure.json`.
        *   `_8_load_progress.py`: Загрузка `progress.json`.
        *   `_9_save_progress.py`: Сохранение `progress.json`.
        *   `_16_create_course_structure.py`: GUI-хелпер (использует `QFileDialog`, `QMessageBox`) для создания структуры курса из текста в редакторе (`main.py`). Использует `_3_initialize_course`.
        *   `_17_open_course.py`: GUI-хелпер для открытия существующего курса. Использует `_6_load_course_structure`.
        *   `_18_select_section.py`: GUI-хелпер для отображения диалога выбора секции курса.
        *   `_19_load_demo_text.py`: Предоставляет стартовый текст для `main.py`.
    *   **Настройки:**
        *   `_4_load_settings.py`: Загрузка `settings.json`. Создает файл с дефолтными значениями, если он отсутствует.
        *   `_5_save_settings.py`: Сохранение `settings.json`.
    *   **Взаимодействие с LLM API (LM Studio):**
        *   `_10_get_models.py`: (Потенциально не используется в `main.py`, но доступен) Получение списка доступных моделей с API (`GET /v1/models`).
        *   `_11_send_chat_completion.py`: Отправка запросов к LLM (`POST /v1/chat/completions`) в формате OpenAI API. Включает парсинг ответа для извлечения текста (`get_completion_text`).
        *   `_12_generate_explanation.py`: Формирует промпт и вызывает `_11_send_chat_completion` для генерации текстового объяснения. Учитывает `detail_level` и `user_feedback`.
        *   `_13_generate_exercises.py`: Формирует промпт и вызывает `_11_send_chat_completion` для генерации упражнений в формате JSON. Учитывает `difficulty`. Включает парсинг JSON из ответа LLM.
        *   `_14_check_answer.py`: Формирует промпт (включая вопрос, правильный ответ, ответ пользователя) и вызывает `_11_send_chat_completion` для проверки ответа пользователя. Парсит JSON-ответ LLM с результатом (`is_correct`, `feedback`).
    *   **Логирование:**
        *   `_15_log_error.py`: Настройка логирования (в файл `tutor.log` и консоль). Предоставляет функции `log_error`, `log_info` и т.д.
*   **Файлы данных:**
    *   `settings.json`: Хранит настройки LLM API и параметры генерации.
    *   `tutor.log`: Файл логов ошибок.
    *   **Директория курса:** Создается пользователем, содержит:
        *   `structure.json`: Список секций книги (`[{'id': N, 'title': '...', 'content': '...'}, ...]`).
        *   `progress.json`: Прогресс пользователя (`{'book_path': '...', 'sections': {'section_id': {'completed': bool, 'exercises_completed': int, 'last_viewed': str|None, 'answered': [str]}}}`). `answered` хранит тексты вопросов, на которые дан правильный ответ.

## 3. Основной поток работы (в `main.py`)

1.  **Инициализация:** Загружаются настройки (`_4_load_settings`), создается GUI, загружается демо-текст (`_19_load_demo_text`).
2.  **Создание/Открытие курса:**
    *   **Создать новый курс:** Пользователь выбирает файл книги (`.txt`/.docx) и директорию. Вызывается `_1_load_book`, затем `_3_initialize_course` для создания `structure.json` и `progress.json`. Структура и прогресс загружаются в `main.py`. Опционально отображается первая секция.
    *   **Открыть курс:** Пользователь выбирает директорию курса. Вызывается `_17_open_course`, который загружает структуру (`_6_load_course_structure`) и прогресс (`_8_load_progress`). Отображается диалог выбора секции (`_18_select_section`).
3.  **Выбор секции:** Пользователь выбирает секцию (через `_18_select_section` при открытии или через будущий интерфейс навигации). Текст секции (`section['content']`) отображается в левой панели (`text_edit`). `current_section` в `main.py` обновляется.
4.  **Генерация объяснения:** Пользователь нажимает "Объяснить". Вызывается `_12_generate_explanation` с текстом текущей секции и настройками детализации. Результат отображается в центральной панели (`explanation_edit`).
5.  **Уточнение объяснения:** Пользователь вводит фидбэк в `feedback_edit` и нажимает "Отправить". Вызывается `_12_generate_explanation` с дополнительным параметром `user_feedback`.
6.  **Генерация упражнения:** Пользователь нажимает "Новое упражнение" (или генерируется автоматически после объяснения). Вызывается `_13_generate_exercises` с текстом текущей секции и настройками сложности.
    *   **Фильтрация:** Если открыт курс, из сгенерированных упражнений (`new_exs`) удаляются те, вопросы которых (`ex['question']`) уже есть в `progress['sections'][current_section_id]['answered']`.
    *   Первое из оставшихся упражнений (`current_exercises[0]`) форматируется и отображается в правой панели (`exercise_edit`). Поля ответа и результата очищаются.
7.  **Проверка ответа:** Пользователь вводит ответ в `answer_edit` и нажимает "Проверить ответ". Вызывается `_14_check_answer` с текущим упражнением (`current_exercises[0]`) и ответом пользователя.
    *   Результат (`is_correct`, `feedback`, `correct_answer`) форматируется и отображается в `result_edit`.
    *   **Сохранение прогресса:** Если ответ правильный (`result['is_correct']` is True) и курс открыт, текст вопроса добавляется в `progress['sections'][current_section_id]['answered']`, счетчик `exercises_completed` инкрементируется, и `progress.json` перезаписывается с помощью `_9_save_progress`.
8.  **Настройки:** Пользователь открывает диалог настроек (`SettingsDialog`). При сохранении новые значения записываются в `settings.json` с помощью `_5_save_settings`.
9.  **Логирование:** Ошибки перехватываются в `try...except` блоках и логируются с помощью `_15_log_error.log_error`.

## 4. Ключевые моменты для ИИ

*   **Разделение ответственности:** Четкое разделение между GUI (`main.py`) и логикой (модули `_X_*.py`).
*   **Взаимодействие с LLM:** Происходит исключительно через модули `_11` (базовый вызов), `_12` (объяснения), `_13` (упражнения), `_14` (проверка). Промпты формируются внутри этих модулей. Ожидается специфический формат ответа от LLM (текст или JSON).
*   **Управление состоянием:** `MainWindow` хранит текущее состояние (текст, объяснение, упражнения, путь к курсу, структуру, прогресс, выбранную секцию).
*   **Данные курса:** Структура (`structure.json`) и прогресс (`progress.json`) хранятся в отдельных файлах в директории курса.
*   **Настройки:** Глобальные настройки хранятся в `settings.json`.
*   **Обработка ошибок:** Используется модуль `_15_log_error` и стандартные исключения Python. 